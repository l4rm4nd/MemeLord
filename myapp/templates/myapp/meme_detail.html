{% extends "myapp/base.html" %}
{% load static %}

{% block title %}{{ media.title|default:"Meme" }}{% endblock %}

{% block extra_head %}
<style>
  .detail-container {
    max-width: 1600px;
    margin: 0 auto;
  }

  .media-viewer {
    background: var(--bs-secondary-bg);
    border-radius: 8px;
    padding: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    position: relative;
  }

  html[data-bs-theme="light"] .media-viewer {
    background: #f8f9fa;
  }

  html[data-bs-theme="dark"] .media-viewer {
    background: #1a1d21;
  }

  .media-viewer img,
  .media-viewer video {
    max-width: 100%;
    max-height: 70vh;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .detail-header {
    display: flex;
    align-items: start;
    justify-content: space-between;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .detail-title {
    flex: 1;
    min-width: 0;
  }

  .detail-title h1 {
    font-size: 1.75rem;
    font-weight: 600;
    margin: 0 0 8px 0;
    word-break: break-word;
  }

  .detail-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--bs-secondary-color);
    font-size: 0.9rem;
    flex-wrap: wrap;
  }

  .detail-meta-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .detail-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }

  .tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    padding: 16px 0;
    border-top: 1px solid var(--bs-border-color);
    border-bottom: 1px solid var(--bs-border-color);
    margin: 20px 0;
  }

  .tag-badge {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    background: var(--bs-secondary-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 20px;
    font-size: 0.85rem;
    transition: all 0.2s ease;
    text-decoration: none;
    color: var(--bs-body-color);
  }

  .tag-badge:hover {
    background: var(--bs-primary);
    color: white;
    border-color: var(--bs-primary);
    transform: translateY(-1px);
  }

  .tag-edit-area {
    width: 100%;
    padding: 16px;
    background: var(--bs-secondary-bg);
    border-radius: 8px;
    margin-top: 8px;
  }

  .comments-section {
    margin-top: 32px;
  }

  .comments-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--bs-border-color);
  }

  .comments-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
  }

  .comment-form-card {
    background: var(--bs-secondary-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .comment-form-card h3 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 16px 0;
  }

  .comment-form-card textarea {
    border-radius: 6px;
    border: 1px solid var(--bs-border-color);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .comment-form-card textarea:focus {
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb), 0.1);
  }

  .title-edit-form {
    display: flex;
    gap: 8px;
    align-items: start;
    flex-wrap: wrap;
  }

  .title-edit-form input {
    flex: 1;
    min-width: 250px;
    border-radius: 6px;
  }

  .inline-edit-btns {
    display: flex;
    gap: 6px;
  }

  @media (max-width: 768px) {
    .detail-header {
      flex-direction: column;
    }

    .detail-actions {
      width: 100%;
    }

    .action-btn {
      flex: 1;
      justify-content: center;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="detail-container">
  <!-- Header with title and actions -->
  <div class="detail-header">
    <div class="detail-title">
      <div id="title-display-area">
        <h1>{{ media.title|default:"Untitled meme" }}</h1>
        <div class="detail-meta">
          <div class="detail-meta-item">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
            </svg>
            <span>{{ media.uploader }}</span>
          </div>
          <div class="detail-meta-item">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
            </svg>
            <span>{{ media.created_at|date:"Y-m-d H:i" }}</span>
          </div>
          {% if media.album %}
          <div class="detail-meta-item">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zm8 0A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm-8 8A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm8 0A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3z"/>
            </svg>
            <a href="{% url 'myapp:album_detail' media.album.pk %}" class="text-decoration-none">
              {{ media.album.title }}{% if media.album.is_private %} (private){% endif %}
            </a>
          </div>
          {% endif %}
        </div>
      </div>

      {% if request.user == media.uploader or request.user.is_superuser %}
      <form method="post" action="{% url 'myapp:meme_update_title' media.pk %}" class="d-none title-edit-form" id="title-edit-form">
        {% csrf_token %}
        {{ title_form.title }}
        <div class="inline-edit-btns">
          <button type="submit" class="btn btn-sm btn-primary">Save</button>
          <button type="button" class="btn btn-sm btn-secondary" id="cancel-title-btn">Cancel</button>
        </div>
      </form>
      {% endif %}
    </div>

    <div class="detail-actions">
      <a href="{{ media.file.url }}" download class="btn btn-primary action-btn">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
          <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
        </svg>
        Download
      </a>

      {% if request.user == media.uploader or request.user.is_superuser %}
      <button type="button" class="btn btn-outline-secondary action-btn" id="edit-title-btn">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
        </svg>
        Edit Title
      </button>

      <form method="post" action="{% url 'myapp:meme_delete' media.pk %}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this meme?');">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger action-btn">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
          </svg>
          Delete
        </button>
      </form>
      {% endif %}
    </div>
  </div>

  <!-- Media viewer -->
  <div class="media-viewer">
    {% if media.media_type == 'image' %}
      <img src="{{ media.file.url }}" alt="{{ media.title }}" loading="lazy">
    {% else %}
      <video controls>
        <source src="{{ media.file.url }}" type="{{ media.file.content_type }}">
        Your browser does not support the video tag.
      </video>
    {% endif %}
  </div>

  <!-- Tags section -->
  <div class="tags-container" id="tags-display-area">
    {% for tag in media.tags.all %}
      <a href="{% url 'myapp:meme_list' %}?tag={{ tag.slug }}" class="tag-badge">
        #{{ tag.name }}
      </a>
    {% empty %}
      <span class="text-muted">No tags assigned</span>
    {% endfor %}

    {% if request.user == media.uploader or request.user.is_superuser %}
      <button type="button" class="btn btn-sm btn-outline-secondary" id="edit-tags-btn">
        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
          <path d="M2 1a1 1 0 0 0-1 1v4.586a1 1 0 0 0 .293.707l7 7a1 1 0 0 0 1.414 0l4.586-4.586a1 1 0 0 0 0-1.414l-7-7A1 1 0 0 0 6.586 1H2zm4 3.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
        </svg>
        Edit Tags
      </button>
    {% endif %}
  </div>

  {% if request.user == media.uploader or request.user.is_superuser %}
  <div class="d-none" id="tags-edit-area">
    <div class="tag-edit-area">
      <form method="post" action="{% url 'myapp:meme_update_tags' media.pk %}" id="tags-edit-form">
        {% csrf_token %}
        <div class="position-relative mb-2">
          {{ tag_form.tags_input }}
          <div id="tag-suggestions"
               class="position-absolute w-100 bg-body border border-secondary-subtle mt-1 rounded-3 shadow-sm d-none"
               style="z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
        </div>
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
              <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
            </svg>
            Save Tags
          </button>
          <button type="button" class="btn btn-secondary" id="cancel-tags-btn">Cancel</button>
        </div>
        <div class="form-text mt-2">
          Separate tags with commas. Suggestions appear while typing.
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- Comments section -->
  <div class="comments-section">
    <div class="comments-header">
      <h2>
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px;">
          <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
        </svg>
        Comments (<span id="comment-count">{{ comments_page.paginator.count }}</span>)
      </h2>
      {% if comments_page.paginator.num_pages > 1 %}
      <span class="text-muted small">
        Page {{ comments_page.number }} / {{ comments_page.paginator.num_pages }}
      </span>
      {% endif %}
    </div>

    <div class="row g-3">
      <!-- Comments list (left side on large screens) -->
      <div class="col-lg-8">
        <div class="comments-list" id="comments-list">
          {% include "myapp/partials/comments_block.html" %}
        </div>
      </div>

      <!-- Add comment form (right side on large screens) -->
      <div class="col-lg-4">
        <div class="comment-form-card sticky-lg-top" style="top: 80px;">
          <h3>Add a Comment</h3>
          <form method="post" action="{% url 'myapp:meme_add_comment' media.pk %}" id="comment-form">
            {% csrf_token %}
            {{ comment_form.text }}
            <div id="comment-form-errors" class="invalid-feedback d-block d-none"></div>
            {% if comment_form.text.errors %}
            <div class="invalid-feedback d-block">
              {{ comment_form.text.errors|striptags }}
            </div>
            {% endif %}
            <button type="submit" class="btn btn-primary mt-2 w-100" id="comment-submit-btn">
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
              </svg>
              <span id="comment-submit-text">Post Comment</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const tagsInput = document.getElementById("id_tags_input");
  const suggestionsBox = document.getElementById("tag-suggestions");
  const editTagsBtn = document.getElementById("edit-tags-btn");
  const cancelTagsBtn = document.getElementById("cancel-tags-btn");
  const tagsDisplayArea = document.getElementById("tags-display-area");
  const tagsEditArea = document.getElementById("tags-edit-area");

  // Disable browser autocomplete
  if (tagsInput) {
    tagsInput.setAttribute("autocomplete", "off");
    tagsInput.setAttribute("autocorrect", "off");
    tagsInput.setAttribute("autocapitalize", "off");
    tagsInput.setAttribute("spellcheck", "false");
  }

  // Tag editing toggle
  if (editTagsBtn) {
    editTagsBtn.addEventListener("click", function() {
      tagsDisplayArea.classList.add("d-none");
      tagsEditArea.classList.remove("d-none");
      tagsInput.focus();
    });
  }

  if (cancelTagsBtn) {
    cancelTagsBtn.addEventListener("click", function() {
      tagsDisplayArea.classList.remove("d-none");
      tagsEditArea.classList.add("d-none");
      suggestionsBox.classList.add("d-none");
    });
  }

  // Tag suggestions
  let suggestionTimeout = null;

  function fetchSuggestions(query) {
    if (!query) {
      suggestionsBox.classList.add("d-none");
      suggestionsBox.innerHTML = "";
      return;
    }

    const url = "{% url 'myapp:tag_suggestions' %}?q=" + encodeURIComponent(query);
    fetch(url, {
      headers: {
        "X-Requested-With": "XMLHttpRequest"
      }
    })
    .then(res => res.json())
    .then(data => {
      const results = data.results || [];
      if (!results.length) {
        suggestionsBox.classList.add("d-none");
        suggestionsBox.innerHTML = "";
        return;
      }

      suggestionsBox.innerHTML = "";
      results.forEach(tag => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-sm btn-outline-secondary m-1";
        btn.textContent = "#" + tag.name;
        btn.addEventListener("click", function() {
          let current = tagsInput.value || "";
          let parts = current.split(/,/).map(p => p.trim()).filter(Boolean);

          if (parts.length === 0) {
            parts = [tag.name];
          } else {
            parts[parts.length - 1] = tag.name;
          }

          tagsInput.value = parts.join(", ") + ", ";
          tagsInput.focus();
          suggestionsBox.classList.add("d-none");
          suggestionsBox.innerHTML = "";
        });

        suggestionsBox.appendChild(btn);
      });
      suggestionsBox.classList.remove("d-none");
    })
    .catch(() => {
      suggestionsBox.classList.add("d-none");
    });
  }

  if (tagsInput) {
    tagsInput.addEventListener("input", function() {
      const value = tagsInput.value;
      const lastPart = value.split(/[,#;]/).pop().trim();

      if (suggestionTimeout) {
        clearTimeout(suggestionTimeout);
      }
      suggestionTimeout = setTimeout(() => {
        fetchSuggestions(lastPart);
      }, 200);
    });
  }

  document.addEventListener("click", function(e) {
    if (suggestionsBox && !suggestionsBox.contains(e.target) && e.target !== tagsInput) {
      suggestionsBox.classList.add("d-none");
    }
  });

  // Title editing toggle
  const editTitleBtn = document.getElementById("edit-title-btn");
  const cancelTitleBtn = document.getElementById("cancel-title-btn");
  const titleDisplayArea = document.getElementById("title-display-area");
  const titleEditForm = document.getElementById("title-edit-form");

  if (editTitleBtn) {
    editTitleBtn.addEventListener("click", function() {
      titleDisplayArea.classList.add("d-none");
      titleEditForm.classList.remove("d-none");
      titleEditForm.querySelector("input").focus();
    });
  }

  if (cancelTitleBtn) {
    cancelTitleBtn.addEventListener("click", function() {
      titleDisplayArea.classList.remove("d-none");
      titleEditForm.classList.add("d-none");
    });
  }

  // Comment form AJAX submission
  const commentForm = document.getElementById("comment-form");
  const commentSubmitBtn = document.getElementById("comment-submit-btn");
  const commentSubmitText = document.getElementById("comment-submit-text");
  const commentTextarea = document.querySelector("#comment-form textarea");
  const commentFormErrors = document.getElementById("comment-form-errors");
  const commentsList = document.getElementById("comments-list");
  const commentCount = document.getElementById("comment-count");

  if (commentForm) {
    commentForm.addEventListener("submit", function(e) {
      e.preventDefault();

      // Clear previous errors
      commentFormErrors.classList.add("d-none");
      commentFormErrors.textContent = "";
      commentTextarea.classList.remove("is-invalid");

      // Disable submit button
      commentSubmitBtn.disabled = true;
      commentSubmitText.textContent = "Posting...";

      const formData = new FormData(commentForm);

      fetch(commentForm.action, {
        method: "POST",
        body: formData,
        headers: {
          "X-Requested-With": "XMLHttpRequest"
        }
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            throw data;
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.ok) {
          // Update comments list
          commentsList.innerHTML = data.html;

          // Update comment count
          if (commentCount) {
            commentCount.textContent = data.count;
          }

          // Clear the textarea
          commentTextarea.value = "";

          // Scroll to top of comments
          commentsList.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }
      })
      .catch(error => {
        // Handle errors
        if (error.errors) {
          const errorText = Object.values(error.errors).flat().join(" ");
          commentFormErrors.textContent = errorText;
          commentFormErrors.classList.remove("d-none");
          commentTextarea.classList.add("is-invalid");
        } else {
          commentFormErrors.textContent = "An error occurred while posting your comment.";
          commentFormErrors.classList.remove("d-none");
        }
      })
      .finally(() => {
        // Re-enable submit button
        commentSubmitBtn.disabled = false;
        commentSubmitText.textContent = "Post Comment";
      });
    });
  }

  // Comment deletion with AJAX
  document.addEventListener("click", function(e) {
    const deleteBtn = e.target.closest("[data-comment-delete]");
    if (!deleteBtn) return;

    e.preventDefault();

    if (!confirm("Are you sure you want to delete this comment?")) {
      return;
    }

    const commentId = deleteBtn.dataset.commentDelete;
    const deleteUrl = deleteBtn.dataset.deleteUrl;
    const commentElement = deleteBtn.closest("[data-comment-id]");

    // Get CSRF token
    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

    fetch(deleteUrl, {
      method: "POST",
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": csrfToken
      }
    })
    .then(response => {
      if (response.ok) {
        // Remove the comment element with animation
        if (commentElement) {
          commentElement.style.transition = "opacity 0.3s ease, transform 0.3s ease";
          commentElement.style.opacity = "0";
          commentElement.style.transform = "translateX(-20px)";

          setTimeout(() => {
            commentElement.remove();

            // Update comment count
            if (commentCount) {
              const currentCount = parseInt(commentCount.textContent);
              commentCount.textContent = Math.max(0, currentCount - 1);
            }
          }, 300);
        }
      } else {
        alert("Failed to delete comment. Please try again.");
      }
    })
    .catch(error => {
      console.error("Error deleting comment:", error);
      alert("An error occurred while deleting the comment.");
    });
  });
})();
</script>
{% endblock %}
